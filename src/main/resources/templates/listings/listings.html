<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="partials/head :: head"></head>
<body>
<nav th:replace="partials/topnav :: navbar">
</nav>

<h1>Here are all of the listings</h1>

<div class="second-tier-container">
    <div th:each="listing : ${listings}">
        <div class="third-tier-container buffer">
            <span th:text="${listing.getFoodName()}"></span>
            <p><span th:text="${listing.getDonationDescription()}"></span></p>
            <p><span th:text="${listing.getFoodAmt()}"></span></p>
            <p><span th:text="${listing.getExpDate()}"></span></p>
            <p><span th:text="${listing.getOrganization().getOrgName()}"></span></p>
            <a th:href="@{'/listings/show/' + ${listing.getId()}}">More Info</span></a>
        </div>

    </div>
</div>

<h1>new code starts here</h1>
<div class="map-container container-fluid">
    <div class="mapbox">
        <div class="container-fluid" id='map'>
            <div class="zoom-container text-center justify-content-center align-items-center" id="menu">


            </div>
        </div>
        <link rel='stylesheet'
              href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css'
              type='text/css'/>
    </div>
    <div class="reviews ">
        <div id="mapboxData" th:each="organization : ${organization}" class="flip-card card-item card-deck mt-2 my-2 m-lg-2">
            <div class="flip-card-inner" th:each="organization : ${organization}">
                <!--                <h5 th:text="${}" class="flip-card-front h3"></h5>-->
                <p class="flip-card-front flex-column">
                    <span class="h3" th:text="${organization.getOrgName()}"></span>
                    <br>
                    <span class="h5"
                          th:text="${organization.getOrgStAddress  + ', ' + organization.getOrgCity + ', ' + organization.getOrgState + ', ' + organization.getOrgZip }"></span>
                </p>
                <div class="flip-card-back d-flex flex-column align-items-center" th:each="organization : ${organization}">
                    <button  class="btn w-75 " type="button" id="location"

                            th:text="${organization.getOrgStAddress  + ', ' + organization.getOrgCity + ', ' + organization.getOrgState + ', ' + organization.getOrgZip }"></button>
                    <div class="my-2">
                        <a th:href="@{'organization/{id}'(id=${organization.getId})}">
                            <button class="btn btn-outline-light">Check Us Out</button>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--</div>-->
    <div hidden>
        <div id="orgName" th:each="Organization : ${organization}">
            <div th:each="Organization : ${organization}">
                <h4 class="card-title" th:text="${organization.getOrgName()}"></h4>
                <p id="orgAddress" class="mb-1 biz"><span th:text="${organization.getOrgStAddress()}"></span></p>
                <p id="orgCity" class="mb-1"><span th:text="${organization.getOrgCity()}"></span> <span
                        th:text="${organization.getOrgState()}"></span>, <span
                        th:text="${organization.getOrgZip()}"></span></p>

            </div>
        </div>
    </div>
</div>




<footer th:replace="partials/footer :: footer">
</footer>
<script th:replace="partials/script :: script">
</script>
<script src="keys.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>



<script th:inline="javascript">


    mapboxgl.accessToken = MAPBOX_KEY;
    const inputs = document.getElementsByTagName('input');

    for (const input of inputs) {
        input.onclick = (layer) => {
            const layerId = layer.target.id;
            map.setStyle('mapbox://styles/mapbox/' + layerId);
        };
    }
    const nav = new mapboxgl.NavigationControl({
        showZoom: true
    });

    $(document).ready(function () {
        $('#zoom5').click(function (e) {
            map.flyTo({zoom: 5});
        });
        $(document).ready(function () {
            $('#zoom10').click(function (e) {
                map.flyTo({zoom: 10});
            });
            $(document).ready(function () {
                $('#zoom15').click(function (e) {
                    map.flyTo({zoom: 15});
                })
            });
        });
    });


    $(document).ready(function () {
        $(".removeMarkers").click(function () {
            $('marker').toggle()
        });
    });

    const geojson = {
        'type': 'FeatureCollection',
        'features': [
            {
                'type': 'Feature',
                'properties': {
                    'description':
                    organizationName,
                    'icon': 'theatre-15'
                },
                'geometry': {
                    'type': 'Point',
                    'coordinates': [-98.4916, 29.4260]
                }
            }
        ]
    }

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-98.4916, 29.4252],
        zoom: 10
    });

    const description = geojson.features[0].properties.description;
    // Add markers to the map.

    const geocode = (inputLocation, inputName, inputReviews) => {
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${inputLocation}.json?&access_token=${MAPBOX_KEY}`)
            .then(res => res.json())
            .then(data => {
                console.log(data);
                try {
                    map.flyTo({center: data.features[0].center, essential: true, zoom: 15})

                } catch (e) {
                    console.log(e);
                }
                for (const feature of geojson.features) {
// create a HTML element for each feature

                    const el = document.createElement('div');
                    el.className = 'mapMarker';

// make a marker for each feature and add it to the map

                    new mapboxgl.Marker(el)
                        .setLngLat(data.features[0].center).addTo(map)
                        .setPopup(new mapboxgl.Popup({closeButton: false, offset: 45})
                            // .setHTML(inputName  + inputLocation + inputHours + inputReviews)
                            .setHTML(`
${inputName} <br> ${inputLocation} <br>
`)
                            .addTo(map))
                        .setLngLat(data.features[0].center).addTo(map);

                }
            })
    }

    // $(window).ready( function(){

    $(document).on("mousemove", "#mapboxData", function () {
        console.log(this)
        let organizationLocation = this.querySelector('#location').innerText
        let organizationName = this.getElementsByTagName("p")[0].innerText
        console.log("organizationName", organizationName);
        geocode(organizationLocation, organizationName)
        // })
    });


</script>
</body>
</html>